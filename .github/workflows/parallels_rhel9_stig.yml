name: Parallels RHEL9 Baseline + STIG (Partial Remediation)

on:
  workflow_dispatch: {}   # manual trigger for now

jobs:
  build_and_stig:
    runs-on: self-hosted    # your Mac with Parallels + runner

    env:
      VM_TEMPLATE_UUID: 7458f26b-71a8-4ddb-8b63-c030a4cc2bd7
      VM_NAME: rhel9-baseline-${{ github.run_id }}
      SSH_USER: maintainer     # maintainer account on the VM

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      #######################################################################
      # 1. CLONE VM
      #######################################################################
      - name: Clone Parallels VM from template UUID
        run: |
          echo "[PRL] Cloning template UUID '$VM_TEMPLATE_UUID' into '$VM_NAME'..."
          prlctl clone "$VM_TEMPLATE_UUID" --name "$VM_NAME" --linked

          VM_UUID=$(prlctl list -i "$VM_NAME" | awk '/^ID:/ {print $2}')
          if [ -z "$VM_UUID" ]; then
            echo "[PRL] ERROR: Could not determine UUID for cloned VM."
            exit 1
          fi

          echo "[PRL] New VM UUID: $VM_UUID"
          echo "VM_UUID=$VM_UUID" >> $GITHUB_ENV

      #######################################################################
      # 2. START VM
      #######################################################################
      - name: Start VM
        run: |
          echo "[PRL] Starting VM $VM_UUID..."
          prlctl start "$VM_UUID"

      #######################################################################
      # 3. GET IP ADDRESS
      #######################################################################
      - name: Get VM IP address from prlctl
        run: |
          echo "[PRL] Waiting for VM to report an IP..."
          for i in {1..30}; do
            IP=$(prlctl list -i "$VM_NAME" | awk -F'IP Addresses: ' '/IP Addresses:/ {print $2}' | cut -d',' -f1)
            if [ -n "$IP" ]; then
              echo "[PRL] Found VM IP: $IP"
              echo "VM_IP=$IP" >> $GITHUB_ENV
              exit 0
            fi
            echo "[PRL] No IP yet ($i/30)..."
            sleep 5
          done

          echo "[PRL] ERROR: Failed to obtain IP for VM."
          exit 1

      #######################################################################
      # 4. WAIT FOR PING
      #######################################################################
      - name: Wait for host to respond to ping
        run: |
          echo "[WAIT] Waiting for $VM_IP to respond to ping..."
          for i in {1..60}; do
            if ping -c1 -W1 "$VM_IP" &>/dev/null; then
              echo "[WAIT] Host is responding to ping (attempt $i)."
              exit 0
            fi
            echo "[WAIT] Host not up yet ($i/60)..."
            sleep 5
          done

          echo "[WAIT] ERROR: Host never responded to ping."
          exit 1

      #######################################################################
      # 5. WAIT FOR SSH
      #######################################################################
      - name: Wait for SSH to be ready
        run: |
          echo "[WAIT] Waiting for SSH on $VM_IP:22..."
          for i in {1..60}; do
            if nc -z "$VM_IP" 22; then
              echo "[WAIT] SSH is available (attempt $i)."
              exit 0
            fi
            echo "[WAIT] SSH not ready yet ($i/60)..."
            sleep 5
          done

          echo "[WAIT] ERROR: SSH never became ready."
          exit 1

      #######################################################################
      # 6. RUN OPENSCAP SCAN + PARTIAL REMEDIATION
      #######################################################################
      - name: Run OpenSCAP STIG scan + partial remediation on VM
        run: |
          echo "[SSH] Running STIG scan on $SSH_USER@$VM_IP ..."
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SSH_USER@$VM_IP" 'bash -s' << 'EOF'
          set -euo pipefail

          echo "[REMOTE] Checking for OpenSCAP..."
          if ! command -v oscap >/dev/null; then
            sudo dnf install -y openscap-scanner scap-security-guide
          fi

          PROFILE_ID="xccdf_org.ssgproject.content_profile_stig"
          CONTENT="/usr/share/xml/scap/ssg/content/ssg-rhel9-ds.xml"
          OUT_DIR="/var/tmp/openscap"

          sudo mkdir -p "$OUT_DIR"
          cd "$OUT_DIR"

          echo "[REMOTE] Running scan + PARTIAL remediation (skipping risky rules)..."
          set +e
          sudo oscap xccdf eval \
            --profile "$PROFILE_ID" \
            \
            # ==== HIGH-RISK RULES SKIPPED TO AVOID BRICKING THE VM ====
            --skip-rule xccdf_org.ssgproject.content_rule_sudo_remove_nopasswd \
            --skip-rule xccdf_org.ssgproject.content_rule_require_single_user_mode_auth \
            --skip-rule xccdf_org.ssgproject.content_rule_grub2_enable_fips_mode \
            --skip-rule xccdf_org.ssgproject.content_rule_grub2_password \
            --skip-rule xccdf_org.ssgproject.content_rule_selinux_state \
            --skip-rule xccdf_org.ssgproject.content_rule_selinux_policytype \
            --skip-rule xccdf_org.ssgproject.content_rule_selinux_user_login_roles \
            --skip-rule xccdf_org.ssgproject.content_rule_mount_option_nodev_nonroot_local_partitions \
            --skip-rule xccdf_org.ssgproject.content_rule_mount_option_noexec_nonroot_local_partitions \
            --skip-rule xccdf_org.ssgproject.content_rule_mount_option_nosuid_nonroot_local_partitions \
            --skip-rule xccdf_org.ssgproject.content_rule_mount_option_boot_nodev \
            --skip-rule xccdf_org.ssgproject.content_rule_mount_option_boot_noexec \
            --skip-rule xccdf_org.ssgproject.content_rule_mount_option_boot_nosuid \
            --skip-rule xccdf_org.ssgproject.content_rule_partition_for_var \
            --skip-rule xccdf_org.ssgproject.content_rule_partition_for_var_log \
            --skip-rule xccdf_org.ssgproject.content_rule_partition_for_home \
            --skip-rule xccdf_org.ssgproject.content_rule_partition_for_tmp \
            --skip-rule xccdf_org.ssgproject.content_rule_partition_for_var_tmp \
            --skip-rule xccdf_org.ssgproject.content_rule_sshd_disable_root_login \
            --skip-rule xccdf_org.ssgproject.content_rule_sshd_disable_empty_passwords \
            --skip-rule xccdf_org.ssgproject.content_rule_sshd_disable_rhosts \
            \
            --remediate \
            --results-arf results-arf.xml \
            --report report.html \
            "$CONTENT"
          OSCAP_RC=$?
          set -e

          echo "[REMOTE] OpenSCAP exit code: $OSCAP_RC"
          echo "$OSCAP_RC" | sudo tee "$OUT_DIR/oscap_exit_code" >/dev/null

          exit 0
          EOF

      #######################################################################
      # 7. COPY REPORTS FROM VM
      #######################################################################
      - name: Copy OpenSCAP reports from VM
        if: always()
        run: |
          mkdir -p openscap-output
          echo "[COPY] Downloading scan artifacts..."

          scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/report.html" openscap-output/ || echo "[WARN] Missing report.html"

          scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/results-arf.xml" openscap-output/ || echo "[WARN] Missing results-arf.xml"

          scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/oscap_exit_code" openscap-output/ || echo "1" > openscap-output/oscap_exit_code

      #######################################################################
      # 8. UPLOAD ARTIFACTS
      #######################################################################
      - name: Upload OpenSCAP artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openscap-report
          path: openscap-output/*

      #######################################################################
      # 9. FAIL OR PASS JOB
      #######################################################################
      - name: Fail job if OpenSCAP reported failures
        if: always()
        run: |
          CODE=$(cat openscap-output/oscap_exit_code || echo 1)
          echo "[RESULT] OpenSCAP exit code: $CODE"

          if [ "$CODE" -ne 0 ]; then
            echo "::error::OpenSCAP scan failed with code $CODE"
            exit 1
          fi

          echo "[RESULT] OpenSCAP scan PASSED."

      #######################################################################
      # 10. CLEAN UP VM
      #######################################################################
      - name: Stop and delete VM (cleanup)
        if: always()
        run: |
          echo "[CLEANUP] Stopping and deleting cloned VM..."
          prlctl stop "$VM_UUID" --kill || true
          prlctl delete "$VM_UUID" || true
          echo "[CLEANUP] VM removed."
