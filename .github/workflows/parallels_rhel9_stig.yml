name: RHEL_STIG  # CIS Level 1 sanity-check pipeline

on:
  push:
    branches: [ RHEL_STIG ]
  workflow_dispatch: {}   # still allow manual runs

jobs:
  build_and_stig:
    runs-on: self-hosted    # your Mac runner with Parallels

    env:
      VM_TEMPLATE_UUID: <PUT-YOUR-CIS-TEMPLATE-UUID-HERE>
      VM_NAME: rhel9-baseline-${{ github.run_id }}
      SSH_USER: maintainer     # maintainer account on the VM

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      #######################################################################
      # 1. CLONE VM
      #######################################################################
      - name: Clone Parallels VM from template UUID
        run: |
          echo "[PRL] Cloning template UUID '$VM_TEMPLATE_UUID' into '$VM_NAME'..."
          prlctl clone "$VM_TEMPLATE_UUID" --name "$VM_NAME" --linked

          VM_UUID=$(prlctl list -i "$VM_NAME" | awk '/^ID:/ {print $2}')
          if [ -z "$VM_UUID" ]; then
            echo "[PRL] ERROR: Could not determine UUID for cloned VM."
            exit 1
          fi

          echo "[PRL] New VM UUID: $VM_UUID"
          echo "VM_UUID=$VM_UUID" >> $GITHUB_ENV

      #######################################################################
      # 2. START VM
      #######################################################################
      - name: Start VM
        run: |
          echo "[PRL] Starting VM $VM_UUID..."
          prlctl start "$VM_UUID"

      #######################################################################
      # 3. GET IP ADDRESS
      #######################################################################
      - name: Get VM IP address from prlctl
        run: |
          echo "[PRL] Waiting for VM to report an IP..."
          for i in {1..30}; do
            IP=$(prlctl list -i "$VM_NAME" | awk -F'IP Addresses: ' '/IP Addresses:/ {print $2}' | cut -d',' -f1)
            if [ -n "$IP" ]; then
              echo "[PRL] Found VM IP: $IP"
              echo "VM_IP=$IP" >> $GITHUB_ENV
              exit 0
            fi
            echo "[PRL] No IP yet ($i/30)..."
            sleep 5
          done

          echo "[PRL] ERROR: Failed to obtain IP for VM."
          exit 1

      #######################################################################
      # 4. WAIT FOR PING
      #######################################################################
      - name: Wait for host to respond to ping
        run: |
          echo "[WAIT] Waiting for $VM_IP to respond to ping..."
          for i in {1..60}; do
            if ping -c1 -W1 "$VM_IP" &>/dev/null; then
              echo "[WAIT] Host is responding to ping (attempt $i)."
              exit 0
            fi
            echo "[WAIT] Host not up yet ($i/60)..."
            sleep 5
          done

          echo "[WAIT] ERROR: Host never responded to ping."
          exit 1

      #######################################################################
      # 5. WAIT FOR SSH
      #######################################################################
      - name: Wait for SSH to be ready
        run: |
          echo "[WAIT] Waiting for SSH on $VM_IP:22..."
          for i in {1..60}; do
            if nc -z "$VM_IP" 22; then
              echo "[WAIT] SSH is available (attempt $i)."
              exit 0
            fi
            echo "[WAIT] SSH not ready yet ($i/60)..."
            sleep 5
          done

          echo "[WAIT] ERROR: SSH never became ready."
          exit 1

      #######################################################################
      # 6. RUN OPENSCAP SCAN (CIS LEVEL 1, NO REMEDIATION)
      #######################################################################
      - name: Run OpenSCAP CIS Level 1 scan on VM
        run: |
          echo "[SSH] Running CIS Level 1 scan on $SSH_USER@$VM_IP ..."
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "$SSH_USER@$VM_IP" 'bash -s' << 'EOF'
          set -euo pipefail

          echo "[REMOTE] Checking for OpenSCAP..."
          if ! command -v oscap >/dev/null; then
            echo "[REMOTE] Installing OpenSCAP scanner + content..."
            sudo dnf install -y openscap-scanner scap-security-guide
          fi

          PROFILE_ID="xccdf_org.ssgproject.content_profile_cis_server_l1"
          CONTENT="/usr/share/xml/scap/ssg/content/ssg-rhel9-ds.xml"
          OUT_DIR="/var/tmp/openscap"

          echo "[REMOTE] Resetting openscap output directory..."
          sudo rm -rf "$OUT_DIR"
          sudo mkdir -p "$OUT_DIR"
          sudo chmod 777 "$OUT_DIR"
          echo "[REMOTE] Output directory is ready: $OUT_DIR"

          cd "$OUT_DIR"

          echo "[REMOTE] Running CIS Level 1 scan (NO remediation)..."
          echo "[REMOTE] Command: sudo oscap xccdf eval --profile \"$PROFILE_ID\" --results-arf results-arf.xml --report report.html \"$CONTENT\""

          set +e
          sudo oscap xccdf eval \
            --profile "$PROFILE_ID" \
            --results-arf results-arf.xml \
            --report report.html \
            "$CONTENT"
          OSCAP_RC=$?
          set -e

          echo "[REMOTE] OpenSCAP exit code: $OSCAP_RC"
          echo "$OSCAP_RC" | sudo tee "$OUT_DIR/oscap_exit_code" >/dev/null

          echo "[REMOTE] Extracting compliance score from results-arf.xml..."
          if sudo test -f "$OUT_DIR/results-arf.xml"; then
            SCORE_LINE=$(sudo grep -m1 "<score" "$OUT_DIR/results-arf.xml" || true)
            if [ -n "$SCORE_LINE" ]; then
              SCORE_VAL=$(echo "$SCORE_LINE" | sed -E 's/.*<score[^>]*>([0-9.]+)<\/score>.*/\1/')
              echo "$SCORE_VAL" | sudo tee "$OUT_DIR/compliance_score" >/dev/null
              echo "[REMOTE] Raw compliance score value: $SCORE_VAL"
            else
              echo "[REMOTE] WARNING: Could not find <score> in results-arf.xml, setting score to 0."
              echo "0" | sudo tee "$OUT_DIR/compliance_score" >/dev/null
            fi
          else
            echo "[REMOTE] ERROR: results-arf.xml not found; setting score to 0."
            echo "0" | sudo tee "$OUT_DIR/compliance_score" >/dev/null
          fi

          echo "[REMOTE] Counting severity levels..."
          # Count HIGH findings
          sudo grep -o 'severity="high"' results-arf.xml | wc -l | sudo tee "$OUT_DIR/high_count" >/dev/null
          # Count MEDIUM findings
          sudo grep -o 'severity="medium"' results-arf.xml | wc -l | sudo tee "$OUT_DIR/medium_count" >/dev/null
          # Count LOW findings
          sudo grep -o 'severity="low"' results-arf.xml | wc -l | sudo tee "$OUT_DIR/low_count" >/dev/null

          echo "[REMOTE] Fixing file permissions for artifact copy..."
          sudo chown maintainer:maintainer "$OUT_DIR"/* || true
          sudo chmod 644 "$OUT_DIR"/* || true

          EOF

      #######################################################################
      # 7. COPY REPORTS FROM VM (WITH CONFIRMATION)
      #######################################################################
      - name: Copy OpenSCAP reports from VM
        if: always()
        run: |
          mkdir -p openscap-output
          echo "[COPY] Pulling scan artifacts from $VM_IP ..."

          # REPORT.HTML
          if scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/report.html" openscap-output/; then
            echo "[COPY] ‚úî report.html copied successfully."
          else
            echo "[COPY] ‚ùå report.html missing."
          fi

          # RESULTS-ARF.XML
          if scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/results-arf.xml" openscap-output/; then
            echo "[COPY] ‚úî results-arf.xml copied successfully."
          else
            echo "[COPY] ‚ùå results-arf.xml missing."
          fi

          # EXIT CODE FILE
          if scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/oscap_exit_code" openscap-output/; then
            echo "[COPY] ‚úî oscap_exit_code copied successfully."
          else
            echo "[COPY] ‚ùå oscap_exit_code missing."
          fi

          # COMPLIANCE SCORE
          if scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/compliance_score" openscap-output/; then
            echo "[COPY] ‚úî compliance_score copied successfully."
          else
            echo "[COPY] ‚ùå compliance_score missing."
          fi

          # HIGH COUNT
          if scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/high_count" openscap-output/; then
            echo "[COPY] ‚úî high_count copied successfully."
          else
            echo "[COPY] ‚ùå high_count missing."
          fi

          # MEDIUM COUNT
          if scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/medium_count" openscap-output/; then
            echo "[COPY] ‚úî medium_count copied successfully."
          else
            echo "[COPY] ‚ùå medium_count missing."
          fi

          # LOW COUNT
          if scp -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$VM_IP:/var/tmp/openscap/low_count" openscap-output/; then
            echo "[COPY] ‚úî low_count copied successfully."
          else
            echo "[COPY] ‚ùå low_count missing."
          fi

      #######################################################################
      # 8. UPLOAD ARTIFACTS
      #######################################################################
      - name: Upload OpenSCAP artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openscap-report
          path: openscap-output/*

      #######################################################################
      # 9. ENFORCE 85% COMPLIANCE THRESHOLD
      #######################################################################
      - name: Enforce 85% compliance threshold
        if: always()
        run: |
          if [ ! -f openscap-output/compliance_score ]; then
            echo "::error::Missing compliance_score file; failing pipeline."
            exit 1
          fi

          RAW=$(tr -d ' \t\r\n' < openscap-output/compliance_score)
          if [ -z "$RAW" ]; then
            echo "::error::Empty compliance_score value; failing pipeline."
            exit 1
          fi

          # Normalize score: if <= 1.0, treat as fraction and convert to percentage
          PCT=$(awk -v v="$RAW" 'BEGIN {
            if (v+0 <= 1.0000001) {
              printf "%.2f", v*100;
            } else {
              printf "%.2f", v;
            }
          }')

          echo "[RESULT] OpenSCAP compliance score: ${PCT}%"

          # Export for later steps (summary)
          if [ -n "$PCT" ]; then
            echo "COMPLIANCE_PCT=$PCT" >> $GITHUB_ENV
          fi

          PASS=$(awk -v s="$PCT" 'BEGIN { if (s+0 >= 85.0) print "yes"; else print "no"; }')
          if [ "$PASS" = "yes" ]; then
            echo "COMPLIANCE_STATUS=PASS" >> $GITHUB_ENV
            echo "[RESULT] ‚úÖ Compliance ${PCT}% >= 85% threshold; pipeline PASS."
            exit 0
          else
            echo "COMPLIANCE_STATUS=FAIL" >> $GITHUB_ENV
            echo "::error::‚ùå Compliance ${PCT}% is below 85% threshold; pipeline FAIL."
            exit 1
          fi

      #######################################################################
      # 10. RECORD SUMMARY (WITH HIGH/MED/LOW)
      #######################################################################
      - name: Record compliance summary
        if: always()
        run: |
          P="${COMPLIANCE_PCT:-unknown}"
          S="${COMPLIANCE_STATUS:-FAIL}"
          EMOJI="‚ùå"
          if [ "$S" = "PASS" ]; then EMOJI="‚úÖ"; fi

          HIGH=$(cat openscap-output/high_count 2>/dev/null || echo "0")
          MED=$(cat openscap-output/medium_count 2>/dev/null || echo "0")
          LOW=$(cat openscap-output/low_count 2>/dev/null || echo "0")

          echo "$EMOJI **RHEL CIS Compliance Check**" >> $GITHUB_STEP_SUMMARY
          echo "- **Score:** ${P}%" >> $GITHUB_STEP_SUMMARY
          echo "- **Threshold:** 85%" >> $GITHUB_STEP_SUMMARY
          echo "- **Result:** ${S}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîé Findings Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "- **High Severity:** ${HIGH}" >> $GITHUB_STEP_SUMMARY
          echo "- **Medium Severity:** ${MED}" >> $GITHUB_STEP_SUMMARY
          echo "- **Low Severity:** ${LOW}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts with the full OpenSCAP report are attached to this workflow run." >> $GITHUB_STEP_SUMMARY

      #######################################################################
      # 11. CLEAN UP VM
      #######################################################################
      - name: Stop and delete VM (cleanup)
        if: always()
        run: |
          echo "[CLEANUP] Stopping and deleting cloned VM..."
          prlctl stop "$VM_UUID" --kill || true
          prlctl delete "$VM_UUID" || true
          echo "[CLEANUP] VM removed."
